{% extends "admin/_layout.html" %}
{% block title %}Manage Users{% endblock %}

{% block admin_content %}
<div class="gp-admin-content">
  {% set is_super = (current_user.is_authenticated and current_user.is_super_admin()) %}
  {% set open_add = (request.args.get('add') == '1') %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">User Access</h2>

    {% if is_super %}
      <button class="btn btn-success" type="button" id="gpToggleAddUserBtn">
        +Add User
      </button>
    {% endif %}
  </div>
  
  {% if is_super %}
    <div id="gpAddUserPanel" class="card shadow-sm p-3 mb-3 bg-dark text-light border gp-bordered {% if not open_add %}d-none{% endif %}">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold">Add New User</div>
          <div class="text-muted small">Create login credentials and assign a role.</div>
        </div>
      </div>

      <form method="POST" class="mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="create_user">

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Username (email)</label>
            <input class="form-control bg-dark text-light border-secondary"
                  type="text" name="username" placeholder="person@email.com" required>
          </div>

          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Temporary Password</label>
            <input class="form-control bg-dark text-light border-secondary"
                  type="password" name="password" placeholder="Set a temp password" required>
          </div>

          <div class="col-md-3">
            <label class="form-label small text-muted mb-1">Role</label>
            <select class="form-select bg-dark text-light border-secondary" name="role" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="super_admin">Super Admin</option>
            </select>
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-success" type="submit">Add</button>
            <button type="button" class="btn btn-outline-light" id="gpCancelAddUserBtn">Cancel</button>
          </div>
        </div>

        <div class="text-muted small mt-2">
          Tip: give them a temporary password and have them change it after first login (recommended).
        </div>
      </form>
    </div>
  {% endif %}

  {% if users %}
    {% for u in users %}
      {% set is_me = (current_user.is_authenticated and u.id == current_user.id) %}
      {% set can_edit = (is_super and not is_me) %}

      <div class="card gp-admin-list-item mb-2 shadow-sm p-3 d-flex justify-content-between align-items-center flex-row
                  {% if is_me %}border border-warning{% endif %}">

        <!-- Left -->
        <div class="me-3">
          <div class="fw-bold d-flex align-items-center gap-2 flex-wrap">
            <span class="{% if is_me %}text-warning{% else %}text-light{% endif %}">
              {{ u.username }}
            </span>

            {% if is_me %}
              <span class="badge rounded-pill text-bg-warning">â˜… You</span>
            {% endif %}
          </div>

          <div class="text-muted small">
            Current role: <span class="text-light-emphasis">{{ u.role }}</span>
          </div>
        </div>

        <!-- Right -->
        <div class="d-flex gap-2 flex-shrink-0 align-items-center">

          {% if can_edit %}
            <!-- Super Admin: can change other users' roles -->
            <form method="POST" class="d-flex gap-2 align-items-center mb-0">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="update_role">
              <input type="hidden" name="user_id" value="{{ u.id }}">

              <select class="form-select form-select-sm bg-dark text-light border-secondary"
                      name="role"
                      style="min-width: 170px;">
                <option value="user" {% if u.role=='user' %}selected{% endif %}>User</option>
                <option value="admin" {% if u.role=='admin' %}selected{% endif %}>Admin</option>
                <option value="super_admin" {% if u.role=='super_admin' %}selected{% endif %}>Super Admin</option>
              </select>

              <button class="btn btn-success btn-sm" type="submit">Update</button>
            </form>

            <form method="POST"
                  action="{{ url_for('admin_users_delete', user_id=u.id) }}"
                  class="gp-delete-form mb-0"
                  data-item-type="user"
                  data-item-name="{{ u.username }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
            </form>

          {% elif is_me %}
            <!-- Admin/Super Admin: can change ONLY their own password -->
            <form method="POST" class="d-flex gap-2 align-items-center mb-0 flex-wrap">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="change_password">
              <input type="hidden" name="user_id" value="{{ u.id }}">

              <input class="form-control form-control-sm bg-dark text-light border-secondary"
                    type="password" name="current_password" placeholder="Current" required style="width:140px;">

              <input class="form-control form-control-sm bg-dark text-light border-secondary"
                    type="password" name="new_password" placeholder="New" required style="width:140px;">

              <input class="form-control form-control-sm bg-dark text-light border-secondary"
                    type="password" name="confirm_password" placeholder="Confirm" required style="width:140px;">

              <button class="btn btn-outline-success btn-sm" type="submit">Change</button>
            </form>

          {% else %}
            {# blank on purpose #}
          {% endif %}

        </div>

      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">No users found.</p>
  {% endif %}

  <p class="text-muted small mt-2 mb-0">
    Only Super Admins can change roles, and Super Admins cannot change their own role. Admins can change their own password, and access all other site settings.
  </p>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("gpToggleAddUserBtn");
  const panel = document.getElementById("gpAddUserPanel");
  const cancelBtn = document.getElementById("gpCancelAddUserBtn");

  if (!btn || !panel) return;

  const setOpen = (open) => {
    panel.classList.toggle("d-none", !open);
    btn.textContent = open ? "Close" : "Add User";
  };

  // Initial state (server can force open with ?add=1)
  setOpen(!panel.classList.contains("d-none"));

  btn.addEventListener("click", () => {
    setOpen(panel.classList.contains("d-none")); // toggle
  });

  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => setOpen(false));
  }
});
</script>

{% endblock %}
