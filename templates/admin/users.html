{% extends "admin/_layout.html" %}
{% block title %}Manage Users{% endblock %}

{% set role_labels = {
  "user": "User",
  "admin": "Admin",
  "super_admin": "Super Admin"
} %}


{% block admin_content %}
<div class="gp-admin-content">
  {% set is_super = (current_user.is_authenticated and current_user.is_super_admin()) %}
  {% set open_add = (request.args.get('add') == '1') %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">User Access</h2>

    {% if is_super %}
      <button class="btn btn-success" type="button" id="gpToggleAddUserBtn">
        +Add User
      </button>
    {% endif %}
  </div>
  
  {% if is_super %}
    <div id="gpAddUserPanel" class="card shadow-sm p-3 mb-3 bg-dark text-light border gp-bordered {% if not open_add %}d-none{% endif %}">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold">Add New User</div>
          <div class="text-muted small">Create login credentials and assign a role.</div>
        </div>
      </div>

      <form method="POST" class="mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="create_user">

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Username</label>
            <input class="form-control bg-dark text-light border-secondary"
                  type="text" name="username" required>
          </div>

          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Temporary Password</label>
            <input class="form-control bg-dark text-light border-secondary"
                  type="password" name="password"  required>
          </div>

          <div class="col-md-3">
            <label class="form-label small text-muted mb-1">Role</label>
            <select class="form-select bg-dark text-light border-secondary" name="role" required>
              <option value="admin">Admin</option>
              <option value="super_admin">Super Admin</option>
            </select>
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-success" type="submit">Add</button>
          </div>
        </div>
      </form>
    </div>
  {% endif %}

  {% if users %}
    {% for u in users %}
      {% set is_me = (current_user.is_authenticated and u.id == current_user.id) %}
      {% set can_edit = (is_super and not is_me) %}

      <div class="card gp-admin-list-item mb-2 shadow-sm p-3 d-flex justify-content-between align-items-center flex-row
                  {% if is_me %}border border-warning{% endif %}">

        <!-- Left -->
        <div class="me-3">
          <div class="fw-bold d-flex align-items-center gap-2 flex-wrap">
            <span class="{% if is_me %}text-warning{% else %}text-light{% endif %}">
              {{ u.username }}
            </span>

            {% if is_me %}
              <span class="badge rounded-pill text-bg-warning">â˜… You</span>
            {% endif %}
          </div>

          <div class="text-muted small">
            Current role: <span class="text-light-emphasis">{{ role_labels.get(u.role, u.role) }}</span>
          </div>
        </div>

        <!-- Right -->
        <div class="d-flex gap-2 flex-shrink-0 align-items-center flex-wrap">

          {% if can_edit %}
            <!-- Super Admin: update role (visible) -->
            <form method="POST" class="d-flex gap-2 align-items-center mb-0">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="update_role">
              <input type="hidden" name="user_id" value="{{ u.id }}">

              <select class="form-select form-select-sm bg-dark text-light border-secondary"
                      name="role" style="min-width: 170px;">
                <option value="user" {% if u.role=='user' %}selected{% endif %}>User</option>
                <option value="admin" {% if u.role=='admin' %}selected{% endif %}>Admin</option>
                <option value="super_admin" {% if u.role=='super_admin' %}selected{% endif %}>Super Admin</option>
              </select>

              <button class="btn btn-success btn-sm" type="submit">Update</button>
            </form>

            <!-- Toggle + hidden password reset form (for THIS user) -->
            <button type="button"
                    class="btn btn-sm btn-outline-light gp-toggle-password">
              Reset Password
            </button>

            <div class="gp-password-panel d-none">
              <form method="POST" class="d-flex gap-2 align-items-center mb-0 flex-wrap">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="reset_password">
                <input type="hidden" name="user_id" value="{{ u.id }}">

                <input class="form-control form-control-sm bg-dark text-light border-secondary"
                      type="password" name="new_password" placeholder="New" required style="width:140px;">

                <input class="form-control form-control-sm bg-dark text-light border-secondary"
                      type="password" name="confirm_password" placeholder="Confirm" required style="width:140px;">

                <button class="btn btn-outline-success btn-sm" type="submit">Save</button>
              </form>
            </div>

            <!-- Delete (far right) -->
            <form method="POST"
                  action="{{ url_for('admin_users_delete', user_id=u.id) }}"
                  class="gp-delete-form gp-user-delete mb-0"
                  data-item-type="user"
                  data-item-name="{{ u.username }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
            </form>

          {% elif is_me %}
            <!-- Admin/Super Admin: toggle their OWN password change -->
            <button type="button"
                    class="btn btn-sm btn-outline-light gp-toggle-password">
              Change Password
            </button>

            <div class="gp-password-panel d-none">
              <form method="POST" class="d-flex gap-2 align-items-center mb-0 flex-wrap">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="change_password">
                <input type="hidden" name="user_id" value="{{ u.id }}">

                <input class="form-control form-control-sm bg-dark text-light border-secondary"
                      type="password" name="current_password" placeholder="Current" required style="width:140px;">

                <input class="form-control form-control-sm bg-dark text-light border-secondary"
                      type="password" name="new_password" placeholder="New" required style="width:140px;">

                <input class="form-control form-control-sm bg-dark text-light border-secondary"
                      type="password" name="confirm_password" placeholder="Confirm" required style="width:140px;">

                <button class="btn btn-outline-success btn-sm" type="submit">Save</button>
              </form>
            </div>

          {% else %}
            {# blank on purpose #}
          {% endif %}

        </div>

      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">No users found.</p>
  {% endif %}

  <p class="text-muted small mt-2 mb-0">
    Only Super Admins can change roles, and Super Admins cannot change their own role. Admins can change their own password, and access all other site settings.
  </p>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("gpToggleAddUserBtn");
  const panel = document.getElementById("gpAddUserPanel");
  const cancelBtn = document.getElementById("gpCancelAddUserBtn");

  if (!btn || !panel) return;

  const setOpen = (open) => {
    panel.classList.toggle("d-none", !open);
    btn.classList.toggle("btn-outline-light", open);
    btn.classList.toggle("btn-success", !open);

    btn.textContent = open ? "Cancel" : "+ Add User";
  };

  // Initial state (server can force open with ?add=1)
  setOpen(!panel.classList.contains("d-none"));

  btn.addEventListener("click", () => {
    setOpen(panel.classList.contains("d-none")); // toggle
  });

  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => setOpen(false));
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const toggles = document.querySelectorAll(".gp-toggle-password");

  // Store each button's original label once
  toggles.forEach(btn => {
    btn.dataset.label = btn.textContent.trim();
  });

  const closeCard = (card) => {
    const panel = card.querySelector(".gp-password-panel");
    if (panel) panel.classList.add("d-none");

    const del = card.querySelector(".gp-user-delete");
    if (del) del.classList.remove("d-none");
  };

  toggles.forEach(btn => {
    btn.addEventListener("click", () => {
      const card = btn.closest(".gp-admin-list-item");
      if (!card) return;

      const panel = card.querySelector(".gp-password-panel");
      if (!panel) return;

      const del = card.querySelector(".gp-user-delete");
      const isOpen = !panel.classList.contains("d-none");

      // Close all other panels + restore their labels + show their delete buttons
      document.querySelectorAll(".gp-admin-list-item").forEach(c => closeCard(c));
      toggles.forEach(b => b.textContent = b.dataset.label);

      // Toggle this one
      if (isOpen) {
        // closing
        panel.classList.add("d-none");
        if (del) del.classList.remove("d-none");
        btn.textContent = btn.dataset.label;
      } else {
        // opening
        panel.classList.remove("d-none");
        if (del) del.classList.add("d-none");
        btn.textContent = "Cancel";
      }
    });
  });
});
</script>

{% endblock %}
